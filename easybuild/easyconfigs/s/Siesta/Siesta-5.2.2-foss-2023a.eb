easyblock = 'CMakeMake'

name = 'Siesta'
version = '5.2.2'

homepage = 'https://siesta-project.org/siesta/About/overview.html'

description = """SIESTA is both a method and its computer program implementation, to perform efficient electronic
structure calculations and ab initio molecular dynamics simulations of molecules and solids."""

toolchain = {'name': 'foss', 'version': '2023a'}
toolchainopts = {'usempi': True, 'openmp': True}

source_urls = ['https://gitlab.com/siesta-project/siesta/-/releases/%(version)s/downloads/']
sources = ['siesta-%(version)s.tar.gz']
checksums = ['4efc58fd5adb9b8f55234f47d11f89d268524b0d4c003d145d89d803da94a58c']

builddependencies = [
    ('CMake', '3.26.3'),
    ('ruamel.yaml', '0.17.32'),  # for the tests
]

dependencies = [
    ('ELSI', '2.11.0', '-PEXSI'),
    ('PnetCDF', '1.12.3'),
    ('netCDF-Fortran', '4.6.1'),
    ('libreadline', '8.2'),
]

# 11 out of 291 tests are failing at least on a64fx, Siesta developers say it's ok to skip
local_failing_tests = [
    'newcomm_mpi_np_1',
    'SpinPolarization-fe_noncol_gga',
    'SpinOrbit-FePt-X-X',
    'SpinOrbit-FePt-offsite',
    'Bands-ge_bands_so',
    'Bands-ge_bands_so_bpoints',
    'Bands-ge_bands_so_fatbands',
    'DensityOfStates-pdos_kp_soc',
    'Functionals-dftu_soc',
    'MiscOptions-bulk_bias',
    'MiscOptions-bulk_bias',
]

buildopts = " && SIESTA_TESTS_VERIFY=1 ctest -E '%s'" % '|'.join(local_failing_tests)

sanity_check_paths = {
    'files': ['bin/siesta', 'lib/libsiesta.a'],
    'dirs': ['include', 'share'],
}

moduleclass = 'phys'
